@model IEnumerable<Frontend.Models.Customer>
@{
    ViewData["Title"] = "Customers";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Customers</h2>
    <div>
        <button id="btnAdd" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Add Customer
        </button>
    </div>
</div>

<div id="alerts"></div>

<table class="table table-hover table-striped align-middle" id="customersTable">
    <thead class="table-dark">
        <tr>
            <th style="width:5%">#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th style="width:18%">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null)
        {
            int i = 1;
            foreach (var c in Model)
            {
                <tr data-id="@c.Id">
                    <td>@i</td>
                    <td>@c.Name</td>
                    <td>@c.Email</td>
                    <td>@c.Phone</td>
                    <td>@c.Address</td>
                    <td>
                        <button class="btn btn-sm btn-info btn-detail" data-id="@c.Id"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-warning btn-edit" data-id="@c.Id"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="@c.Id"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
                i++;
            }
        }
    </tbody>
</table>

<!-- Modal: Create/Edit -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalTitle">Create Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
            <input type="hidden" id="Id" />
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input id="Name" class="form-control" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="Email" class="form-control" type="email" />
            </div>
            <div class="mb-3">
                <label class="form-label">Phone</label>
                <input id="Phone" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Address</label>
                <input id="Address" class="form-control" />
            </div>
        </form>
        <div id="modalAlert"></div>
      </div>
      <div class="modal-footer">
        <button id="saveBtn" class="btn btn-primary">Save</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Details -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
            <dt class="col-sm-3">Name</dt><dd class="col-sm-9" id="dName"></dd>
            <dt class="col-sm-3">Email</dt><dd class="col-sm-9" id="dEmail"></dd>
            <dt class="col-sm-3">Phone</dt><dd class="col-sm-9" id="dPhone"></dd>
            <dt class="col-sm-3">Address</dt><dd class="col-sm-9" id="dAddress"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
    $(function () {
        const $customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
        const $detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

        function showAlert(type, message) {
            $('#alerts').html(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`);
        }

        // Open Create modal
        $('#btnAdd').click(function () {
            $('#customerModalTitle').text('Create Customer');
            $('#modalAlert').html('');
            $('#Id').val('');
            $('#Name').val('');
            $('#Email').val('');
            $('#Phone').val('');
            $('#Address').val('');
            $('#saveBtn').data('mode', 'create');
            $customerModal.show();
        });

        // Open Edit modal
        $('.btn-edit').click(async function () {
            const id = $(this).data('id');
            $('#modalAlert').html('');
            const res = await $.get(`/Customer/GetById?id=${id}`);
            if (res) {
                $('#customerModalTitle').text('Edit Customer');
                $('#Id').val(res.id);
                $('#Name').val(res.name);
                $('#Email').val(res.email);
                $('#Phone').val(res.phone);
                $('#Address').val(res.address);
                $('#saveBtn').data('mode', 'edit');
                $customerModal.show();
            } else {
                showAlert('danger', 'Customer not found');
            }
        });

        // Details
        $('.btn-detail').click(async function () {
            const id = $(this).data('id');
            const res = await $.get(`/Customer/GetById?id=${id}`);
            if (res) {
                $('#dName').text(res.name);
                $('#dEmail').text(res.email);
                $('#dPhone').text(res.phone);
                $('#dAddress').text(res.address);
                $detailsModal.show();
            } else {
                showAlert('danger', 'Customer not found');
            }
        });

        // Delete (confirm then call)
        $('.btn-delete').click(function () {
            const id = $(this).data('id');
            if (confirm('Are you sure you want to delete this customer?')) {
                $.ajax({
                    url: `/Customer/DeleteAjax?id=${id}`,
                    type: 'DELETE',
                    success: function () {
                        showAlert('success', 'Customer deleted');
                        setTimeout(() => location.reload(), 600);
                    },
                    error: function (xhr) {
                        showAlert('danger', 'Delete failed: ' + xhr.responseText);
                    }
                });
            }
        });

        // Save (create or edit)
        $('#saveBtn').click(function () {
            const mode = $(this).data('mode') || 'create';
            const customer = {
                id: $('#Id').val() || 0,
                name: $('#Name').val(),
                email: $('#Email').val(),
                phone: $('#Phone').val(),
                address: $('#Address').val()
            };

            if (!customer.name) {
                $('#modalAlert').html(`<div class="alert alert-warning">Name is required</div>`);
                return;
            }

            if (mode === 'create') {
                $.ajax({
                    url: '/Customer/CreateAjax',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(customer),
                    success: function (data) {
                        $customerModal.hide();
                        showAlert('success', 'Customer created');
                        setTimeout(() => location.reload(), 600);
                    },
                    error: function (xhr) {
                        $('#modalAlert').html(`<div class="alert alert-danger">Create failed: ${xhr.responseText}</div>`);
                    }
                });
            } else {
                $.ajax({
                    url: '/Customer/EditAjax',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(customer),
                    success: function () {
                        $customerModal.hide();
                        showAlert('success', 'Customer updated');
                        setTimeout(() => location.reload(), 600);
                    },
                    error: function (xhr) {
                        $('#modalAlert').html(`<div class="alert alert-danger">Update failed: ${xhr.responseText}</div>`);
                    }
                });
            }
        });
    });
</script>
}
